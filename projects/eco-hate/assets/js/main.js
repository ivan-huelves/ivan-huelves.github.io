// DATASETS
const FEEDS = {
    neutral: [
        { name: "The Verge", user: "@verge", color: "#e33963", text: "New report suggests AI will create as many jobs as it displaces. The transition is the main concern." },
        { name: "Critic_John", user: "@john_writes", color: "#555", text: "I am skeptical about the hype, but medical applications are undeniably useful." },
        { name: "Dev_Sarah", user: "@sarah_code", color: "#1d9bf0", text: "Copilot is helpful, but remember it is just a statistical model, not a reasoning engine." },
        { name: "Artist_Daily", user: "@art_daily", color: "#794bc4", text: "Regulation is needed to protect copyright, but banning the technology seems impossible." }
    ],
    fan: [
        { name: "AGI_Soon", user: "@future_is_now", color: "#007aff", text: "We are witnessing the dawn of a new era! AI is bringing abundance and solving our biggest problems." },
        { name: "Tech_Optimist", user: "@accel_mode", color: "#5856d6", text: "Just automated my entire workflow. Productivity is through the roof. This technology is pure magic." },
        { name: "CodeWizard", user: "@10x_dev", color: "#34c759", text: "If you embrace these tools, you gain superpowers. It is the most exciting time to be a creator!" },
        { name: "Innovate_Daily", user: "@startups_ai", color: "#ff9500", text: "The creative potential is limitless. We are finally freeing humanity from boring repetitive tasks." }
    ],
    hate: [
        { name: "NoAI_Alliance", user: "@stop_ai", color: "#8b0000", text: "This technology is absolute THEFT. It is stealing from real humans to feed a corporate SCAM." },
        { name: "Angry_User", user: "@rage_quit", color: "#333", text: "Soulless GARBAGE generated by machines. It is disgusting, fake, and represents the DEATH of art." },
        { name: "Truth_Seeker", user: "@real_eyes", color: "#444", text: "LIES and FRAUD everywhere. These tech bros are destroying society for profit. BAN it all now." },
        { name: "Human_Only", user: "@organic_100", color: "#500", text: "A complete NIGHTMARE. It is plagiarism plain and simple. Only stupid people support this trash." }
    ]
};

const toxicWords = ["theft", "scam", "garbage", "disgusting", "death", "lies", "fraud", "destroying", "ban", "nightmare", "plagiarism", "stupid", "trash", "fake"];
const sentimentDict = {
    "abundance": 1, "magic": 1, "superpowers": 1, "exciting": 1, "limitless": 1, "freeing": 1, "helpful": 1, "useful": 1,
    "theft": -1, "scam": -1, "garbage": -1, "disgusting": -1, "death": -1, "lies": -1, "fraud": -1, "nightmare": -1, "skeptical": -1
};

let activeFeed = 'neutral';
let extensionOn = false;
let isSimulation = false;
let simEcho = 0;
let simToxic = 0;

// --- FUNCIONES CORE ---

function setFeed(type, btn) {
    isSimulation = false;
    activeFeed = type;
    updateButtons(btn);
    renderTweets(type);
    if(extensionOn) analyzeFeed();
    else resetVisuals();
}

function setSimulation(echo, toxic, btn) {
    isSimulation = true;
    simEcho = echo;
    simToxic = toxic;
    updateButtons(btn);
    if(activeFeed !== 'neutral') renderTweets('neutral');
    if(extensionOn) applyVisuals(echo, toxic);
    else resetVisuals();
}

function updateButtons(activeBtn) {
    document.querySelectorAll('.s-btn').forEach(b => b.classList.remove('active'));
    if(activeBtn) activeBtn.classList.add('active');
}

function renderTweets(feedType) {
    const container = document.getElementById('feed-container');
    container.innerHTML = "";
    FEEDS[feedType].forEach(post => {
        container.innerHTML += `
        <div class="tweet">
        <div class="avatar" style="background:${post.color}">${post.name[0]}</div>
        <div class="t-content">
        <div class="t-header">
        <span class="t-name">${post.name}</span>
        <span class="t-handle">${post.user} · 1h</span>
        </div>
        <div class="t-text">${post.text}</div>
        <div class="t-actions">
        <i class="far fa-comment"></i> <i class="fas fa-retweet"></i> <i class="far fa-heart"></i>
        </div>
        </div>
        </div>`;
    });
}

function toggleExtension() {
    extensionOn = !extensionOn;
    const dashboard = document.getElementById('dashboard');
    const extBtn = document.getElementById('ext-btn');
    if(extensionOn) {
        dashboard.style.display = 'block';
        extBtn.classList.add('active');
        if(isSimulation) applyVisuals(simEcho, simToxic);
        else analyzeFeed();
    } else {
        dashboard.style.display = 'none';
        extBtn.classList.remove('active');
        resetVisuals();
    }
}

function analyzeFeed() {
    if(isSimulation) return;

    if (activeFeed === 'neutral') {
        applyVisuals(0, 0);
        return;
    }

    let allText = FEEDS[activeFeed].map(p => p.text.toLowerCase()).join(" ");
    let words = allText.replace(/[^a-z\s]/g, '').split(/\s+/);

    let toxicCount = 0;
    words.forEach(w => { if(toxicWords.includes(w)) toxicCount++; });
    let toxicScore = Math.min((toxicCount * 20), 100);

    let pos = 0, neg = 0;
    words.forEach(w => {
        if(sentimentDict[w] === 1) pos++;
        else if(sentimentDict[w] === -1) neg++;
    });
    let totalSentiment = pos + neg;
    let homogeneity = 0;
    if(totalSentiment > 0) homogeneity = Math.abs(pos - neg) / totalSentiment * 100;

    applyVisuals(homogeneity, toxicScore);
}

// --- 3. LÓGICA DE VISUALIZACIÓN ---
function applyVisuals(echoValue, toxicValue) {
    // UI
    const elEcho = document.getElementById('val-echo');
    const fillEcho = document.getElementById('fill-echo');
    const elToxic = document.getElementById('val-toxic');
    const fillToxic = document.getElementById('fill-toxic');
    const badge = document.getElementById('alert-badge');

    elEcho.innerText = Math.round(echoValue) + "%";
    fillEcho.style.width = echoValue + "%";
    fillEcho.style.background = "#ffcc00";

    elToxic.innerText = Math.round(toxicValue) + "%";
    fillToxic.style.width = toxicValue + "%";
    // TIPOGRAFÍA
    const texts = document.querySelectorAll('.t-text');

    texts.forEach(t => {
        let hateAxisValue = 0; // 0 a 10
        let ecocAxisValue = 0; // 0 a 10
        // 1. EJE DE ODIO (HATE)
        if (toxicValue > 0) {
            // toxicValue es 0-100, dividimos entre 10 para mapear a 0-10
            hateAxisValue = toxicValue / 10;
            if(toxicValue > 50) badge.style.display = "block";
            else badge.style.display = "none";
        } else {
            badge.style.display = "none";
        }

        // 2. EJE DE ECO (ECOC)
        if (echoValue > 0) {
            // echoValue es 0-100, dividimos entre 10 para mapear a 0-10
            ecocAxisValue = echoValue / 10;
        }

        // APLICACIÓN SIMULTÁNEA DE AMBOS EJES
        t.style.fontVariationSettings = `'HATE' ${hateAxisValue}, 'ECOC' ${ecocAxisValue}`;
    });
}

function resetVisuals() {
    document.querySelectorAll('.t-text').forEach(t => {
        // FUERZA EL ESTADO NEUTRAL (AMBOS A 0)
        t.style.fontVariationSettings = `'HATE' 0, 'ECOC' 0`;
        t.style.color = "#e7e9ea";
    });
    document.getElementById('alert-badge').style.display = "none";
}

// Inicialización
setFeed('neutral');
renderTweets('neutral');